import json
import random
import time
import traceback
import unicodedata
from datetime import date, datetime

from openai import AsyncOpenAI

from config import (
    OPENAI_KEY,
    OPENAI_MAX_ATTEMPTS,
    OPENAI_REQUEST_TIMEOUT_SEC,
    OPENAI_TEMPERATURE,
    QUIZ_GENERATION_TIMEOUT_SEC,
)
from topics import MASTER_TOPICS, normalize_topic

PROMPT_STATIC = """–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –¢–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≥—Ä–µ—á–µ—Å–∫–∏–π —è–∑—ã–∫ (ŒΩŒ≠Œ± ŒµŒªŒªŒ∑ŒΩŒπŒ∫ŒÆ Œ≥ŒªœéœÉœÉŒ±).
- –ù–∏–∫–∞–∫–æ–≥–æ –∫–∏–ø—Ä—Å–∫–æ–≥–æ –¥–∏–∞–ª–µ–∫—Ç–∞, –∫–∏–ø—Ä—Å–∫–∏—Ö —Å–ª–æ–≤, –∫–∏–ø—Ä—Å–∫–æ–≥–æ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è.
- –£—á–µ–Ω–∏–∫ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥—Ä–µ—á–µ—Å–∫—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É. –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞, –±–µ–∑ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞.
- –ö–ê–ñ–î–´–ô –≤–æ–ø—Ä–æ—Å –æ–±—è–∑–∞–Ω –±—ã—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω –≤ –º–∏–Ω–∏-—Å–∏—Ç—É–∞—Ü–∏—é –∏–∑ –∂–∏–∑–Ω–∏ —É—á–µ–Ω–∏–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –≤—ã—à–µ (–≥–æ—Ä–æ–¥, —Ä–∞–±–æ—Ç—É, —Ö–æ–±–±–∏, —Å–µ–º—å—é, –∏–Ω—Ç–µ—Ä–µ—Å—ã) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π. –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –Ω–∞—á–∏–Ω–∞–π —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –ø–æ—Ç–æ–º –∑–∞–¥–∞–≤–∞–π —è–∑—ã–∫–æ–≤—É—é –∑–∞–¥–∞—á—É.
  –ü–ª–æ—Ö–æ: ¬´–ö–∞–∫ —Å–∫–∞–∑–∞—Ç—å –ø–æ-–≥—Ä–µ—á–µ—Å–∫–∏: "31 –¥–µ–∫–∞–±—Ä—è"?¬ª
  –•–æ—Ä–æ—à–æ: ¬´–¢—ã –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞–µ—à—å—Å—è —Å –∫–æ–ª–ª–µ–≥–æ–π –æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–µ. –ö–∞–∫ —Å–∫–∞–∑–∞—Ç—å: "–í–µ—á–µ—Ä–∏–Ω–∫–∞ –±—É–¥–µ—Ç 31 –¥–µ–∫–∞–±—Ä—è"?¬ª
  –ü–ª–æ—Ö–æ: ¬´–í—Å—Ç–∞–≤—å –∞—Ä—Ç–∏–∫–ª—å: ___ Œ≥œÖŒΩŒ±ŒØŒ∫Œ± ŒµŒØŒΩŒ±Œπ œåŒºŒøœÅœÜŒ∑.¬ª
  –•–æ—Ä–æ—à–æ: ¬´–¢—ã —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å —Å–æ—Å–µ–¥—É –æ –∂–µ–Ω–µ. –í—Å—Ç–∞–≤—å –Ω—É–∂–Ω—ã–π –∞—Ä—Ç–∏–∫–ª—å: "___ Œ≥œÖŒΩŒ±ŒØŒ∫Œ± ŒºŒøœÖ ŒµŒØŒΩŒ±Œπ œÄŒøŒªœç œâœÅŒ±ŒØŒ±."¬ª
- –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ –∏ –º–µ—Å—Ç–∞ –¥–µ–π—Å—Ç–≤–∏—è: —Å–æ—Å–µ–¥, –∫–æ–ª–ª–µ–≥–∞, –≤—Ä–∞—á, –ø—Ä–æ–¥–∞–≤–µ—Ü, —Ç—É—Ä–∏—Å—Ç, –Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü –Ω–∞ —É–ª–∏—Ü–µ, –æ—Ñ–∏—Ü–∏–∞–Ω—Ç, –∫–∞—Å—Å–∏—Ä, —Ä–µ–±—ë–Ω–æ–∫. –ú–µ—Å—Ç–∞: –∫–∞—Ñ–µ, —Ä—ã–Ω–æ–∫, –∞–≤—Ç–æ–±—É—Å, –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞, –º–∞–≥–∞–∑–∏–Ω, –ø–ª—è–∂, –∞–ø—Ç–µ–∫–∞, –æ—Ñ–∏—Å, –ª–∏—Ñ—Ç. –ß–µ—Ä–µ–¥—É–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã: –ø—Ä–æ—Å—å–±–∞, —É–¥–∏–≤–ª–µ–Ω–∏–µ, –ø—Ä–æ–±–ª–µ–º–∞, —Å—Ä–æ—á–Ω–æ—Å—Ç—å, —Ä–∞–¥–æ—Å—Ç—å, –Ω–µ–ª–æ–≤–∫–æ—Å—Ç—å. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–≤–∞–∂–¥—ã –≤ –æ–¥–Ω–æ–º –∫–≤–∏–∑–µ.
- –ê–ù–¢–ò–ü–û–í–¢–û–†–´ –ú–ï–ñ–î–£ –î–ù–Ø–ú–ò: –Ω–µ –∫–æ–ø–∏—Ä—É–π –¥–æ—Å–ª–æ–≤–Ω–æ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –ø—Ä–æ—à–ª—ã—Ö –∫–≤–∏–∑–æ–≤. –î–∞–∂–µ –ø—Ä–∏ —Ç–æ–π –∂–µ —Ç–µ–º–µ –º–µ–Ω—è–π —Å—é–∂–µ—Ç, —Ä–æ–ª–∏, –¥–µ—Ç–∞–ª–∏, —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –∏ —Ü–µ–ª–µ–≤—É—é —Ñ—Ä–∞–∑—É. –ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–æ–≤ –≤–∏–¥–∞ ¬´–≤ –º–∞–≥–∞–∑–∏–Ω–µ –∫—É–ø–∏ —Ö–ª–µ–±¬ª –∏–∑ –∫–≤–∏–∑–∞ –≤ –∫–≤–∏–∑.
- –ü–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —Å–æ—Å—Ç–∞–≤—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ¬´–ø–ª–∞–Ω —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è¬ª –Ω–∞ 20 –≤–æ–ø—Ä–æ—Å–æ–≤: –º–∏–Ω–∏–º—É–º 10 —Ä–∞–∑–Ω—ã—Ö –º–∏–∫—Ä–æ—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –º–∏–Ω–∏–º—É–º 8 —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, –º–∏–Ω–∏–º—É–º 8 —Ä–∞–∑–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–π. –ü–ª–∞–Ω –Ω–µ –≤—ã–≤–æ–¥–∏ –≤ –æ—Ç–≤–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏.
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê: –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞ (–≥–æ—Ä–æ–¥, —Ä–∞–±–æ—Ç–∞/–∑–∞–Ω—è—Ç–∏–µ, —Å–µ–º—å—è, —Ö–æ–±–±–∏, —Ü–µ–ª–∏). –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å–Ω–∞—è –¥–µ—Ç–∞–ª—å —É–∂–µ –≤—Å—Ç—Ä–µ—á–∞–ª–∞—Å—å, –∏—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–≥–æ–π –∞—Å–ø–µ–∫—Ç –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –Ω–æ–≤—ã–π —Ä–∞–∫—É—Ä—Å —ç—Ç–æ–π –¥–µ—Ç–∞–ª–∏.

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø—Ä–∏ –ø–æ–¥–±–æ—Ä–µ —Ç–µ–º –¥–ª—è –≠–¢–û–ì–û –∫–≤–∏–∑–∞:
- üî¥ –¢–µ–º—ã –Ω–∏–∂–µ 60% ‚Üí 35% –≤–æ–ø—Ä–æ—Å–æ–≤ (—Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- üü° –¢–µ–º—ã 60-85%   ‚Üí 25% –≤–æ–ø—Ä–æ—Å–æ–≤ (–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ)
- üü¢ –¢–µ–º—ã –≤—ã—à–µ 85% ‚Üí 10% –≤–æ–ø—Ä–æ—Å–æ–≤ (–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ)
- ‚ö™ –¢–µ–º—ã –±–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ (0 –≤–æ–ø—Ä–æ—Å–æ–≤) ‚Üí 30% –≤–æ–ø—Ä–æ—Å–æ–≤ (–Ω–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª)
  ‚Ä¢ –í–≤–æ–¥–∏ 2-4 –Ω–æ–≤—ã–µ —Ç–µ–º—ã –∑–∞ –∫–≤–∏–∑, –Ω–µ –±–æ–ª—å—à–µ ‚Äî –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π —É—á–µ–Ω–∏–∫–∞
  ‚Ä¢ –í—ã–±–∏—Ä–∞–π –Ω–æ–≤—ã–µ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–≥–∏—á–Ω–æ —Å–æ—á–µ—Ç–∞—é—Ç—Å—è —Å —Ç–µ–∫—É—â–∏–º –∫–≤–∏–∑–æ–º
- –¢–µ–º—ã —Å –±–æ–ª—å—à–∏–º —á–∏—Å–ª–æ–º –¥–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ ‚Äî –≤–∫–ª—é—á–∞—Ç—å —á–∞—â–µ

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –ø–æ–ª–µ "topic":
–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç—Ç–∏ —Ç–æ—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ–º (—Å–∫–æ–ø–∏—Ä—É–π —Å—Ç—Ä–æ–∫—É —Ü–µ–ª–∏–∫–æ–º, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):
–ì–ª–∞–≥–æ–ª—ã, –ü—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è, –ë—É–¥—É—â–µ–µ –≤—Ä–µ–º—è, –û—Ç—Ä–∏—Ü–∞–Ω–∏–µ, –ú–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è, –ê—Ä—Ç–∏–∫–ª–∏, –°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ, –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ, –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è, –ß–∏—Å–ª–∞, –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞, –ü—Ä–µ–¥–ª–æ–≥–∏ –∏ —Å–æ—é–∑—ã, –ë—ã—Ç–æ–≤—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏, –í—Ä–µ–º—è –∏ –¥–∞—Ç–∞, –°–µ–º—å—è, –ß–∞—Å—Ç–∏ —Ç–µ–ª–∞, –ü–æ–≥–æ–¥–∞, –î–æ–º –∏ –∫–≤–∞—Ä—Ç–∏—Ä–∞, –ï–¥–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç—ã, –û–¥–µ–∂–¥–∞, –ù–∞—Ä–µ—á–∏—è
–ó–ê–ü–†–ï–©–ï–ù–û: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥—Ä–µ—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã –≤–Ω—É—Ç—Ä–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–µ–º—ã. –ù–∞–∑–≤–∞–Ω–∏—è —Ç–µ–º ‚Äî —Å—Ç—Ä–æ–≥–æ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞, —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ.
–¢–µ–º–∞ = —Ç–æ, —á—Ç–æ –ü–†–û–í–ï–†–Ø–ï–¢–°–Ø –≤ –≤–æ–ø—Ä–æ—Å–µ, –∞ –Ω–µ —Ç–æ, —á—Ç–æ —É–ø–æ–º—è–Ω—É—Ç–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–µ–¥–ª–æ–≥ –ø–µ—Ä–µ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –¥–Ω—è ‚Äî —Ç–µ–º–∞ "–ü—Ä–µ–¥–ª–æ–≥–∏ –∏ —Å–æ—é–∑—ã", –Ω–µ "–í—Ä–µ–º—è –∏ –¥–∞—Ç–∞".
–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞–¥–µ–∂ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –µ–¥—ã ‚Äî —Ç–µ–º–∞ "–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ", –Ω–µ "–ï–¥–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç—ã".

–ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—á–µ–Ω—å —Ç–µ–º (–≤—Å–µ —Ç–µ–º—ã –¥–æ–ª–∂–Ω—ã –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º):
–ì–õ–ê–ì–û–õ–´: ŒµŒØŒºŒ±Œπ, Œ≠œáœâ, Œ∏Œ≠Œªœâ, Œ∫Œ¨ŒΩœâ, œÄŒ¨œâ, ŒºœÄŒøœÅœé, ŒæŒ≠œÅœâ, Œ≤ŒªŒ≠œÄœâ, œÑœÅœéœâ, œÄŒØŒΩœâ, ŒºŒπŒªŒ¨œâ, ŒªŒ≠œâ, ŒºŒ≠ŒΩœâ, Œ¥ŒøœÖŒªŒµœçœâ, Œ±Œ≥ŒøœÅŒ¨Œ∂œâ, œÄŒªŒ∑œÅœéŒΩœâ, œÄŒ±ŒØœÅŒΩœâ, Œ¥ŒØŒΩœâ, Œ±ŒΩŒøŒØŒ≥œâ, Œ∫ŒªŒµŒØŒΩœâ, Œ±œÅœáŒØŒ∂œâ, œÑŒµŒªŒµŒπœéŒΩœâ
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—ã–±–æ—Ä –Ω—É–∂–Ω–æ–≥–æ –≥–ª–∞–≥–æ–ª–∞ –ø–æ —Å–º—ã—Å–ª—É, —Å–ø—Ä—è–∂–µ–Ω–∏–µ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –≤—Ä–µ–º–µ–Ω–∏
–ü–†–û–®–ï–î–®–ï–ï –í–†–ï–ú–Ø: Œ±œåœÅŒπœÉœÑŒøœÇ ‚Äî œÄŒÆŒ≥Œ±, ŒµŒØœÄŒ±, Œ≠Œ∫Œ±ŒΩŒ±, ŒÆŒ∏ŒµŒªŒ±, ŒµŒØœáŒ±, ŒÆŒºŒøœÖŒΩ, Œ±Œ≥œåœÅŒ±œÉŒ±, œÄŒªŒÆœÅœâœÉŒ±, œÄŒÆœÅŒ±, ŒµŒØŒ¥Œ± –∏ –¥—Ä.
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Ñ–æ—Ä–º—É –≥–ª–∞–≥–æ–ª–∞ –≤ –ø—Ä–æ—à–µ–¥—à–µ–º –≤—Ä–µ–º–µ–Ω–∏ (Œ±œåœÅŒπœÉœÑŒøœÇ)
–ë–£–î–£–©–ï–ï –í–†–ï–ú–Ø: Œ∏Œ± + –≥–ª–∞–≥–æ–ª ‚Äî Œ∏Œ± œÄŒ¨œâ, Œ∏Œ± Œ∫Œ¨ŒΩœâ, Œ∏Œ± Œ±Œ≥ŒøœÅŒ¨œÉœâ, Œ∏Œ± ŒºŒπŒªŒÆœÉœâ –∏ –¥—Ä.
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Ñ–æ—Ä–º—É –≥–ª–∞–≥–æ–ª–∞ –≤ –±—É–¥—É—â–µ–º –≤—Ä–µ–º–µ–Ω–∏ (Œ∏Œ± + –≥–ª–∞–≥–æ–ª)
–û–¢–†–ò–¶–ê–ù–ò–ï: Œ¥ŒµŒΩ, ŒºŒ∑ŒΩ
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—ã–±–æ—Ä Œ¥ŒµŒΩ –∏–ª–∏ ŒºŒ∑ŒΩ –≤ –Ω—É–∂–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
–ú–ï–°–¢–û–ò–ú–ï–ù–ò–Ø: –ª–∏—á–Ω—ã–µ (ŒµŒ≥œé/ŒµœÉœç/Œ±œÖœÑœåœÇ/Œ±œÖœÑŒÆ/Œ±œÖœÑœå/ŒµŒºŒµŒØœÇ/ŒµœÉŒµŒØœÇ/Œ±œÖœÑŒøŒØ), —Å–ª–∞–±—ã–µ –∏ —Å–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã, –ø—Ä–∏—Ç—è–∂–∞—Ç–µ–ª—å–Ω—ã–µ
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—ã–±–æ—Ä –∏ —Ñ–æ—Ä–º—É –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è (–ª–∏—á–Ω–æ–≥–æ –∏–ª–∏ –ø—Ä–∏—Ç—è–∂–∞—Ç–µ–ª—å–Ω–æ–≥–æ)
–ê–†–¢–ò–ö–õ–ò: –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π, –≤—Å–µ —Ä–æ–¥—ã, –≤—Å–µ –ø–∞–¥–µ–∂–∏
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—ã–±–æ—Ä –∞—Ä—Ç–∏–∫–ª—è –ø–æ —Ä–æ–¥—É, —á–∏—Å–ª—É –∏ –ø–∞–¥–µ–∂—É —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ
–°–£–©–ï–°–¢–í–ò–¢–ï–õ–¨–ù–´–ï: —Ç—Ä–∏ —Ä–æ–¥–∞, –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π/–≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π/—Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂–∏, –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ –∏ —á–∏—Å–ª–æ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ
–ü–†–ò–õ–ê–ì–ê–¢–ï–õ–¨–ù–´–ï: —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –ø–æ —Ä–æ–¥—É, —á–∏—Å–ª—É, –ø–∞–¥–µ–∂—É
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Å —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º
–£–ö–ê–ó–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–°–¢–û–ò–ú–ï–ù–ò–Ø: Œ±œÖœÑœåœÇ/Œ±œÖœÑŒÆ/Œ±œÖœÑœå, ŒµŒ∫ŒµŒØŒΩŒøœÇ/ŒµŒ∫ŒµŒØŒΩŒ∑/ŒµŒ∫ŒµŒØŒΩŒø
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—ã–±–æ—Ä –∏ —Ñ–æ—Ä–º—É —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è –ø–æ —Ä–æ–¥—É/—á–∏—Å–ª—É/–ø–∞–¥–µ–∂—É
–ß–ò–°–õ–ê: –æ—Ç 0 –¥–æ 1000, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ —Ä–æ–¥—É (1/3/4), –¥–∞—Ç—ã, –≤—Ä–µ–º—è
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –∑–Ω–∞–Ω–∏–µ —á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∏ –∏—Ö —Ñ–æ—Ä–º; –∫–∞–∫ –Ω–∞–∑–≤–∞—Ç—å —Ü–µ–Ω—É, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –Ω–æ–º–µ—Ä
–í–û–ü–†–û–°–ò–¢–ï–õ–¨–ù–´–ï –°–õ–û–í–ê: œÄŒøœç, œÄœåœÑŒµ, œÑŒπ, œÄŒøŒπŒøœÇ, œÄœéœÇ, œÄœåœÉŒø, Œ≥ŒπŒ±œÑŒØ, Œ±œÄœå œÄŒøœç
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—ã–±–æ—Ä –Ω—É–∂–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ–≤–∞ –ø–æ —Å–º—ã—Å–ª—É
–ü–†–ï–î–õ–û–ì–ò –ò –°–û–Æ–ó–´: œÉŒµ, Œ±œÄœå, ŒºŒµ, Œ≥ŒπŒ±, Œ∫Œ±Œπ, Œ±ŒªŒªŒ¨, ŒÆ, Œ≥ŒπŒ±œÑŒØ, œåœÑŒ±ŒΩ
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—ã–±–æ—Ä –Ω—É–∂–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–≥–∞ –∏–ª–∏ —Å–æ—é–∑–∞, –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø–µ—Ä–µ–¥ –¥–Ω—è–º–∏, –º–µ—Å—Ç–∞–º–∏ –∏ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏
–ë–´–¢–û–í–´–ï –°–ò–¢–£–ê–¶–ò–ò: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ, –∫–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –º–∞–≥–∞–∑–∏–Ω –∏ —Ä—ã–Ω–æ–∫, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –≤—Ä–∞—á –∏ –∞–ø—Ç–µ–∫–∞, –≥–æ—Å—Ç–∏–Ω–∏—Ü–∞, –ø–æ—á—Ç–∞, –±–∞–Ω–∫
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –≥–æ—Ç–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã –∏ —Ä–µ–ø–ª–∏–∫–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö
–í–†–ï–ú–Ø –ò –î–ê–¢–ê: –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏, –º–µ—Å—è—Ü—ã, –≤—Ä–µ–º–µ–Ω–∞ –≥–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å, –∫–æ–≥–¥–∞
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –∑–Ω–∞–Ω–∏–µ —Å–ª–æ–≤ (–∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–µ–Ω—å/–º–µ—Å—è—Ü/—Å–µ–∑–æ–Ω/–≤—Ä–µ–º—è —Å—É—Ç–æ–∫); –ù–ï –ø—Ä–µ–¥–ª–æ–≥–∏ –∏–ª–∏ –ø–∞–¥–µ–∂–∏ –ø—Ä–∏ –Ω–∏—Ö
–°–ï–ú–¨–Ø: ŒºŒ±ŒºŒ¨, ŒºœÄŒ±ŒºœÄŒ¨œÇ, œÄŒ±ŒπŒ¥ŒØ, Œ¥ŒπŒ¥œçŒºŒπŒ±, Œ≥œÖŒΩŒ±ŒØŒ∫Œ±, Œ¨ŒΩœÑœÅŒ±œÇ, Œ±Œ¥ŒµœÅœÜœåœÇ, Œ±Œ¥ŒµœÅœÜŒÆ, œÄŒ±œÄœÄŒøœçœÇ, Œ≥ŒπŒ±Œ≥ŒπŒ¨, ŒøŒπŒ∫ŒøŒ≥Œ≠ŒΩŒµŒπŒ±, œÄŒ±ŒΩœÑœÅŒµŒºŒ≠ŒΩŒøœÇ
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏ –∏ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π
–ß–ê–°–¢–ò –¢–ï–õ–ê: Œ∫ŒµœÜŒ¨ŒªŒπ, œáŒ≠œÅŒπ, œÄœåŒ¥Œπ, œÉœÑŒøŒºŒ¨œáŒπ, œÄŒªŒ¨œÑŒ∑, ŒºŒ¨œÑŒπ, Œ±œÖœÑŒØ, ŒºœçœÑŒ∑, œÉœÑœåŒºŒ±, Œ¥œåŒΩœÑŒπ, ŒªŒ±ŒπŒºœåœÇ
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Å—Ç–µ–π —Ç–µ–ª–∞
–ü–û–ì–û–î–ê: ŒÆŒªŒπŒøœÇ, Œ≤œÅŒøœáŒÆ, Œ∂Œ≠œÉœÑŒ∑, Œ∫œÅœçŒø, Œ±Œ≠œÅŒ±œÇ, Œ∏ŒµœÅŒºŒøŒ∫œÅŒ±œÉŒØŒ±, œÉœÖŒΩŒΩŒµœÜŒπŒ¨, Œ∏Œ¨ŒªŒ±œÉœÉŒ±, Œ∫Œ±ŒπœÅœåœÇ
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å ‚Äî –∫–∞–∫ –æ–ø–∏—Å–∞—Ç—å –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
–î–û–ú/–ö–í–ê–†–¢–ò–†–ê: œÉœÄŒØœÑŒπ, Œ¥œâŒºŒ¨œÑŒπŒø, Œ∫ŒøœÖŒ∂ŒØŒΩŒ±, ŒºœÄŒ¨ŒΩŒπŒø, œÉŒ±ŒªœåŒΩŒπ, ŒºœÄŒ±ŒªŒ∫œåŒΩŒπ, ŒµŒΩŒøŒØŒ∫ŒπŒø, Œ≥ŒµŒØœÑŒøŒΩŒ±œÇ, Œ¥ŒπŒ±ŒºŒ≠œÅŒπœÉŒºŒ±
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–º–µ—â–µ–Ω–∏–π –∏ –±—ã—Ç–æ–≤—ã—Ö —Ä–µ–∞–ª–∏–π
–ï–î–ê/–ü–†–û–î–£–ö–¢–´: œàœâŒºŒØ, Œ∫œÅŒ≠Œ±œÇ, ŒªŒ±œáŒ±ŒΩŒπŒ∫Œ¨, œÜœÅŒøœçœÑŒ±, Œ≥Œ¨ŒªŒ±, œÑœÖœÅŒØ, œàŒ¨œÅŒπ, ŒΩŒµœÅœå, Œ∫Œ±œÜŒ≠œÇ, œÉŒøœçœÄŒµœÅ ŒºŒ¨œÅŒ∫ŒµœÑ, Œ±Œ≥ŒøœÅŒ¨
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è –µ–¥—ã –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤; –ù–ï –ø–∞–¥–µ–∂ –∏–ª–∏ –∞—Ä—Ç–∏–∫–ª—å –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –µ–¥—ã
–û–î–ï–ñ–î–ê: œÅŒøœçœáŒ±, œÄŒ±œÄŒøœçœÑœÉŒπŒ±, œÜœåœÅŒµŒºŒ±, œÄŒ±ŒΩœÑŒµŒªœåŒΩŒπ, ŒºœÄŒªŒøœçŒ∂Œ±, ŒºŒ≠Œ≥ŒµŒ∏ŒøœÇ, œáœÅœéŒºŒ±, œÜŒøœÅŒ¨œâ
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è –æ–¥–µ–∂–¥—ã, –∫–∞–∫ —Å–∫–∞–∑–∞—Ç—å —á—Ç–æ –Ω–∞–¥–µ—Ç—å –∏–ª–∏ –∫—É–ø–∏—Ç—å
–ù–ê–†–ï–ß–ò–Ø: œÄŒ¨ŒΩœÑŒ±, œÄŒøœÑŒ≠, œÉœÖœáŒΩŒ¨, ŒºŒµœÅŒπŒ∫Œ≠œÇ œÜŒøœÅŒ≠œÇ, ŒÆŒ¥Œ∑, Œ±Œ∫œåŒºŒ±, œÉœçŒΩœÑŒøŒºŒ±, Œ±ŒºŒ≠œÉœâœÇ, ŒºŒ±Œ∂ŒØ, ŒºœåŒΩŒøœÇ, œÄŒøŒªœç, ŒªŒØŒ≥Œø
  ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –≤—ã–±–æ—Ä –Ω—É–∂–Ω–æ–≥–æ –Ω–∞—Ä–µ—á–∏—è –ø–æ —Å–º—ã—Å–ª—É –∏ –µ–≥–æ –º–µ—Å—Ç–æ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏

–¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–π –ø–æ —Å–º—ã—Å–ª—É —Ç–µ–º—ã, –Ω–µ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏:
1. ru_to_gr ‚Äî –ø–µ—Ä–µ–≤–æ–¥ —Ñ—Ä–∞–∑—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–∏—Ç—É–∞—Ü–∏–∏: "–¢—ã –≤ –∫–∞—Ñ–µ, –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –∂–¥—ë—Ç –∑–∞–∫–∞–∑. –ö–∞–∫ —Å–∫–∞–∑–∞—Ç—å: ¬´–Ø —Ö–æ—á—É –∫–æ—Ñ–µ –∏ –≤–æ–¥—É¬ª?" ‚Äî 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–∞ –≥—Ä–µ—á–µ—Å–∫–æ–º
2. gr_to_ru ‚Äî –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≥—Ä–µ—á–µ—Å–∫–æ–π —Ä–µ–ø–ª–∏–∫–∏ –∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏: "–ù–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü –≥–æ–≤–æ—Ä–∏—Ç —Ç–µ–±–µ: ¬´Œ†Œøœç ŒµŒØŒΩŒ±Œπ Œ∑ œÉœÑŒ¨œÉŒ∑;¬ª ‚Äî —á—Ç–æ –æ–Ω —Å–ø—Ä–æ—Å–∏–ª?" ‚Äî 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
3. choose_form ‚Äî –≤—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏-—Å–∏—Ç—É–∞—Ü–∏–∏: "–¢—ã –≥–æ–≤–æ—Ä–∏—à—å –¥—Ä—É–≥—É, –∫–æ–≥–æ –≤–∏–¥–∏—à—å —É –ê–≥–æ—Ä—ã: ¬´ŒíŒªŒ≠œÄœâ ___ (–∫—Ä–∞—Å–∏–≤–∞—è –∂–µ–Ω—â–∏–Ω–∞).¬ª" ‚Äî 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏
4. fill_blank ‚Äî –≤—Å—Ç–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ –≤ –¥–∏–∞–ª–æ–≥ –∏–ª–∏ —Ñ—Ä–∞–∑—É –∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏: "–°–æ—Å–µ–¥ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≥–¥–µ —Ç—ã –∂–∏–≤—ë—à—å. –¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å: ¬´ŒïŒ≥œé ___ œÉœÑŒ∑ ŒõŒµŒºŒµœÉœå.¬ª" ‚Äî 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–∞ –≥—Ä–µ—á–µ—Å–∫–æ–º

–í—ã–±–æ—Ä —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ —Ç–µ–º–µ:
- –¢–µ–º—ã-—Å–ª–æ–≤–∞—Ä—å (–í—Ä–µ–º—è –∏ –¥–∞—Ç–∞, –ï–¥–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç—ã, –°–µ–º—å—è, –ß–∞—Å—Ç–∏ —Ç–µ–ª–∞, –ü–æ–≥–æ–¥–∞, –û–¥–µ–∂–¥–∞, –î–æ–º –∏ –∫–≤–∞—Ä—Ç–∏—Ä–∞, –ë—ã—Ç–æ–≤—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏):
  –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π ru_to_gr –∏ gr_to_ru ‚Äî –ø—Ä–æ–≤–µ—Ä—è–π –∑–Ω–∞–Ω–∏–µ —Å–ª–æ–≤ –∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–π
- –¢–µ–º—ã-–≥—Ä–∞–º–º–∞—Ç–∏–∫–∞ (–ì–ª–∞–≥–æ–ª—ã, –ê—Ä—Ç–∏–∫–ª–∏, –°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ, –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ, –ú–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è, –ü—Ä–µ–¥–ª–æ–≥–∏ –∏ —Å–æ—é–∑—ã, –ü—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è, –ë—É–¥—É—â–µ–µ –≤—Ä–µ–º—è, –û—Ç—Ä–∏—Ü–∞–Ω–∏–µ, –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è, –ù–∞—Ä–µ—á–∏—è):
  –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π choose_form –∏ fill_blank ‚Äî –ø—Ä–æ–≤–µ—Ä—è–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É
- –ß–∏—Å–ª–∞, –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞: –ª—é–±—ã–µ —Ç–∏–ø—ã, –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏
–û–±—â–∏–π –±–∞–ª–∞–Ω—Å —Ç–∏–ø–æ–≤ –ø–æ –≤—Å–µ–º—É –∫–≤–∏–∑—É ‚Äî –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ—Ä–æ–≤–Ω—É (–ø–æ ~5 –∫–∞–∂–¥–æ–≥–æ).

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –°–¢–†–û–ì–û 20 –≤–æ–ø—Ä–æ—Å–æ–≤. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ markdown, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –≤–Ω–µ JSON.

–ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤–µ:
{
  "question": "—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ",
  "options": ["–≤–∞—Ä–∏–∞–Ω—Ç1", "–≤–∞—Ä–∏–∞–Ω—Ç2", "–≤–∞—Ä–∏–∞–Ω—Ç3", "–≤–∞—Ä–∏–∞–Ω—Ç4"],
  "correctIndex": 2,
  "explanation": "–ø–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚Äî –ø–æ–ª–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π, 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
  "topic": "–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã",
  "type": "ru_to_gr | gr_to_ru | choose_form | fill_blank"
}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—è—Å–Ω–µ–Ω–∏—è–º:
- –ü–æ–ª–Ω—ã–µ —Å–ª–æ–≤–∞, –±–µ–∑ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π (–Ω–µ '–∏–º.–ø.' –∞ '–∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂').
- –û–±—ä—è—Å–Ω–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ. 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.

–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º ‚Äî correctIndex —É–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞.
–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Äî –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–µ: –ø–æ—Ö–æ–∂–∏–µ —Ñ–æ—Ä–º—ã, –±–ª–∏–∑–∫–∏–µ —Å–ª–æ–≤–∞, —á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏.
–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –≤—Å–µ 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤ –∫–∞–∂–¥–æ–º –≤–æ–ø—Ä–æ—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
–ñ–Å–°–¢–ö–û–ï –ü–†–ê–í–ò–õ–û: –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤–∞—Ä–∏–∞–Ω—Ç—ã-–¥–≤–æ–π–Ω–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–æ–π, –∑–∞–ø—è—Ç–æ–π, –ª–∏—à–Ω–∏–º –ø—Ä–æ–±–µ–ª–æ–º –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–æ–º. –ï—Å–ª–∏ —Ç—ã —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî –ø–µ—Ä–µ–ø–∏—à–∏ –¥–∏—Å—Ç—Ä–∞–∫—Ç–æ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é.
–ü–õ–û–•–û: ["–∏–¥—É –¥–æ–º–æ–π", "–∏–¥—É –¥–æ–º–æ–π.", "–ò–¥—É –¥–æ–º–æ–π", "–∏–¥—É  –¥–æ–º–æ–π"] ‚Äî —ç—Ç–æ –ø–æ–≤—Ç–æ—Ä—ã.
–•–û–†–û–®–û: –∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–µ—Å—ë—Ç —Ä–∞–∑–Ω—ã–π —Å–º—ã—Å–ª –∏–ª–∏ —Ä–∞–∑–Ω—É—é –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É.

–°–¢–†–£–ö–¢–£–†–ê JSON –ù–ï–ò–ó–ú–ï–ù–ù–ê ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤:
‚Ä¢ –í–µ—Ä–Ω–∏ JSON-–æ–±—ä–µ–∫—Ç –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ–ª–µ–º "questions".
‚Ä¢ –í –ø–æ–ª–µ "questions" ‚Äî —Ä–æ–≤–Ω–æ 20 –æ–±—ä–µ–∫—Ç–æ–≤ (–Ω–µ –º–µ–Ω—å—à–µ –∏ –Ω–µ –±–æ–ª—å—à–µ).
‚Ä¢ –ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–æ–≤–Ω–æ 6 –ø–æ–ª–µ–π: question, options, correctIndex, explanation, topic, type.
‚Ä¢ options ‚Äî –º–∞—Å—Å–∏–≤ —Ä–æ–≤–Ω–æ –∏–∑ 4 —Å—Ç—Ä–æ–∫.
‚Ä¢ correctIndex ‚Äî —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ: 0, 1, 2 –∏–ª–∏ 3.
‚Ä¢ –ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON-–æ–±—ä–µ–∫—Ç–∞, –Ω–∏–∫–∞–∫–∏—Ö ```json``` –æ–±—ë—Ä—Ç–æ–∫, –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
‚Ä¢ –ö–∞–∂–¥—ã–π question, option –∏ explanation –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ã—á–Ω–æ–π JSON-—Å—Ç—Ä–æ–∫–æ–π (–±–µ–∑ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫, –±–µ–∑ —Å–ª—É–∂–µ–±–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤).

–ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞ —Å–¥–µ–ª–∞–π –°–ê–ú–û–ü–†–û–í–ï–†–ö–£:
1) JSON –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è ‚Äî –æ–±—ä–µ–∫—Ç —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∫–ª—é—á–æ–º "questions".
2) –í –º–∞—Å—Å–∏–≤–µ questions —Ä–æ–≤–Ω–æ 20 –æ–±—ä–µ–∫—Ç–æ–≤.
3) –í –∫–∞–∂–¥–æ–º –æ–±—ä–µ–∫—Ç–µ —Ä–æ–≤–Ω–æ 6 –Ω—É–∂–Ω—ã—Ö –ø–æ–ª–µ–π.
4) –í –∫–∞–∂–¥–æ–º –æ–±—ä–µ–∫—Ç–µ options —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–æ–≤–Ω–æ 4 –£–ù–ò–ö–ê–õ–¨–ù–´–ï —Å—Ç—Ä–æ–∫–∏.
5) correctIndex —É–∫–∞–∑—ã–≤–∞–µ—Ç –∏–º–µ–Ω–Ω–æ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.
6) topic –≤—Ö–æ–¥–∏—Ç –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫, type –≤—Ö–æ–¥–∏—Ç –≤: ru_to_gr, gr_to_ru, choose_form, fill_blank.
7) –í—ã–≤–æ–¥–∏—à—å –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç, –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤/—Å—É—Ñ—Ñ–∏–∫—Å–æ–≤.
–í—Å—è —Ç–≤–æ—Ä—á–µ—Å–∫–∞—è —Å–≤–æ–±–æ–¥–∞ ‚Äî –≤ —Ç–µ–∫—Å—Ç–µ: –∂–∏–≤—ã–µ –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏, —è—Ä–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, –±–æ–≥–∞—Ç—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è."""


def build_profile_section(profile: dict) -> str:
    """Build the personal section of the system prompt from user profile data."""
    name = profile.get("display_name") or "–£—á–µ–Ω–∏–∫"
    age = profile.get("age")
    city = profile.get("city") or "?"
    native_lang = profile.get("native_lang") or "?"
    other_langs = profile.get("other_langs") or ""
    occupation = profile.get("occupation") or "?"
    family = profile.get("family_status") or "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
    hobbies = profile.get("hobbies") or "?"
    greek_goal = profile.get("greek_goal") or "–∏–∑—É—á–µ–Ω–∏–µ –≥—Ä–µ—á–µ—Å–∫–æ–≥–æ"
    exam_date = profile.get("exam_date")

    age_str = f", {age} –ª–µ—Ç" if age else ""
    other_langs_line = ""
    if other_langs and other_langs.lower() not in ("–Ω–µ—Ç –¥—Ä—É–≥–∏—Ö", "–Ω–µ—Ç", "no"):
        other_langs_line = f" –î—Ä—É–≥–∏–µ —è–∑—ã–∫–∏: {other_langs}."

    goal_line = f"–ú–µ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: {greek_goal}."
    if exam_date:
        if isinstance(exam_date, date):
            goal_line += f" –°–¥–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω {exam_date.strftime('%d.%m.%Y')}."
        else:
            goal_line += f" –°–¥–∞—Ç—å —ç–∫–∑–∞–º–µ–Ω {exam_date}."

    return (
        f"–£—á–µ–Ω–∏–∫: {name}{age_str}, –∂–∏–≤—ë—Ç –≤ {city}.\n"
        f"–†–æ–¥–Ω–æ–π —è–∑—ã–∫: {native_lang}.{other_langs_line}\n"
        f"–†–∞–±–æ—Ç–∞/–∑–∞–Ω—è—Ç–∏–µ: {occupation}.\n"
        f"–°–µ–º—å—è: {family}.\n"
        f"–•–æ–±–±–∏: {hobbies}.\n"
        f"{goal_line}"
    )


def build_system_prompt(profile: dict) -> str:
    """Combine intro + personal profile + static quiz rules into the full system prompt."""
    profile_section = build_profile_section(profile)
    return (
        "–¢—ã –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–≤–∏–∑–∞ –ø–æ –≥—Ä–µ—á–µ—Å–∫–æ–º—É —è–∑—ã–∫—É —É—Ä–æ–≤–Ω—è A2.\n\n"
        + profile_section
        + "\n\n"
        + PROMPT_STATIC
    )


def build_dynamic_prompt(stats, session_dates, profile, required_topics=None):
    """
    Returns only the dynamic part of the prompt ‚Äî per-session stats + conditional notes.

    stats        ‚Äî {topic: {correct, total, last_seen}}  (from topic_stats, compact)
    session_dates ‚Äî sorted list of date strings          (from quiz_sessions, compact)

    Dynamic prompt size is O(number_of_topics) ‚Äî never grows with raw history length.
    """
    # Learning period: first 3 unique quiz days ‚Äî collect broad statistics before adapting
    learning_days = len(session_dates)
    is_learning = learning_days < 3

    days_away = days_since_last_session(session_dates)
    today = datetime.now().strftime("%Y-%m-%d")

    # Seen topics sorted weakest-first, with recency indicator
    hist_lines = []
    for topic, s in sorted(stats.items(),
                           key=lambda x: x[1]["correct"] / max(x[1]["total"], 1)):
        if s["total"] == 0:
            continue  # listed separately below as unseen
        pct = round(s["correct"] / s["total"] * 100)
        bar = "üî¥" if pct < 60 else "üü°" if pct < 85 else "üü¢"
        recency = ""
        if s.get("last_seen"):
            ds = (datetime.strptime(today, "%Y-%m-%d") -
                  datetime.strptime(s["last_seen"], "%Y-%m-%d")).days
            recency = f", {ds}–¥ –Ω–∞–∑–∞–¥" if ds > 0 else ", —Å–µ–≥–æ–¥–Ω—è"
        hist_lines.append(f"  {bar} {topic}: {pct}% ({s['total']} –≤–æ–ø—Ä.{recency})")

    hist_summary = "\n".join(hist_lines) if hist_lines else "  (–∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ ‚Äî –ø–µ—Ä–≤–∞—è —Å–µ—Å—Å–∏—è)"

    # Unseen topics ‚Äî explicitly listed so the model knows exactly what hasn't been practiced
    unseen = [t for t in MASTER_TOPICS if t not in stats or stats[t]["total"] == 0]
    if unseen:
        hist_summary += (
            f"\n\n‚ö™ –¢–µ–º—ã –±–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ ({len(unseen)} —à—Ç.) ‚Äî –≤–≤–æ–¥–∏ –ø–æ 2-4 –∑–∞ –∫–≤–∏–∑:\n"
            + "\n".join(f"  ‚ö™ {t}" for t in unseen)
        )

    learning_note = ""
    if is_learning:
        learning_note = (
            f"–†–ï–ñ–ò–ú –û–ë–£–ß–ï–ù–ò–Ø (–¥–µ–Ω—å {learning_days + 1} –∏–∑ 3): —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏. "
            f"–ò–≥–Ω–æ—Ä–∏—Ä—É–π –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–æ —Å–ª–∞–±—ã–º/—Å–∏–ª—å–Ω—ã–º —Ç–µ–º–∞–º –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ ‚Äî –æ–Ω–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 3 –¥–Ω–µ–π –æ–±—É—á–µ–Ω–∏—è. "
            f"–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –æ—Ö–≤–∞—Ç—ã–≤–∞–π –≤—Å–µ —Ç–µ–º—ã, –≤–≤–æ–¥–∏ 4-5 –Ω–æ–≤—ã—Ö —Ç–µ–º –∑–∞ –∫–≤–∏–∑. "
            f"–¶–µ–ª—å ‚Äî —Å–æ–±—Ä–∞—Ç—å –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞–∫—Å–∏–º—É–º—É —Ç–µ–º.\n"
        )

    review_note = ""
    if not is_learning and days_away >= 2:
        review_note = (
            "–í–ê–ñ–ù–û: —É—á–µ–Ω–∏–∫ –Ω–µ –∑–∞–Ω–∏–º–∞–ª—Å—è –±–æ–ª–µ–µ 2 –¥–Ω–µ–π. "
            "–ü–µ—Ä–≤—ã–µ 8 –≤–æ–ø—Ä–æ—Å–æ–≤ —Å—Ç—Ä–æ–≥–æ –∏–∑ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ (–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ). "
            "–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –Ω–æ–≤–æ–º—É.\n"
        )

    exam_date_obj = profile.get("exam_date") if profile else None
    exam_line = ""
    pre_exam_note = ""
    if exam_date_obj:
        if isinstance(exam_date_obj, date):
            days_left = max((exam_date_obj - date.today()).days, 0)
        else:
            days_left = 0
        if days_left > 0:
            exam_line = f"–î–æ —ç–∫–∑–∞–º–µ–Ω–∞: {days_left} –¥–Ω–µ–π.\n"
            if days_left <= 30:
                pre_exam_note = (
                    "–ü–†–ï–î–≠–ö–ó–ê–ú–ï–ù–ê–¶–ò–û–ù–ù–´–ô –†–ï–ñ–ò–ú: –∏–∑ 20 –≤–æ–ø—Ä–æ—Å–æ–≤ —Ä–æ–≤–Ω–æ 6 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ "
                    "–∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–∏–∞–ª–æ–≥ –Ω–∞ –≥—Ä–µ—á–µ—Å–∫–æ–º (3-5 —Å—Ç—Ä–æ–∫) + –≤–æ–ø—Ä–æ—Å –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ. "
                    "–≠—Ç–∏ 6 –≤–æ–ø—Ä–æ—Å–æ–≤ –≤—Ö–æ–¥—è—Ç –≤ –æ–±—â–∏–π –ª–∏–º–∏—Ç 20, –Ω–µ —Å–≤–µ—Ä—Ö –Ω–µ–≥–æ.\n"
                )

    variety_hint = random.choice([
        "—Ñ–æ–∫—É—Å –Ω–∞ –±—ã—Ç–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ –∏ –±—ã—Å—Ç—Ä—ã–µ —Ä–µ–ø–ª–∏–∫–∏",
        "—Ñ–æ–∫—É—Å –Ω–∞ –º–∏–Ω–∏-–∏—Å—Ç–æ—Ä–∏–∏ —Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–π –¥–µ—Ç–∞–ª—å—é",
        "—Ñ–æ–∫—É—Å –Ω–∞ –≤–µ–∂–ª–∏–≤—ã–µ –ø—Ä–æ—Å—å–±—ã –∏ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã",
        "—Ñ–æ–∫—É—Å –Ω–∞ –∂–∏–≤—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã —Å —ç–º–æ—Ü–∏—è–º–∏",
        "—Ñ–æ–∫—É—Å –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π —Ä—É—Ç–∏–Ω—ã",
    ])

    topic_plan_block = ""
    if required_topics:
        numbered = "\n".join(f"  {i+1}. {topic}" for i, topic in enumerate(required_topics))
        topic_plan_block = (
            "\n\n–°–ï–†–í–ï–†–ù–´–ô –ü–õ–ê–ù –¢–ï–ú (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):\n"
            "–î–ª—è –≤–æ–ø—Ä–æ—Å–∞ i (–æ—Ç 1 –¥–æ 20) –ø–æ–ª–µ topic –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –†–û–í–ù–û –∫–∞–∫ –≤ —Å—Ç—Ä–æ–∫–µ i –Ω–∏–∂–µ.\n"
            f"{numbered}\n"
        )

    return (
        f"{exam_line}"
        f"{learning_note}"
        f"{review_note}"
        f"{pre_exam_note}"
        f"–í–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ–∫—É—Å —ç—Ç–æ–≥–æ –∫–≤–∏–∑–∞: {variety_hint}. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –∫–∞–∫ —Å—Ç–∏–ª—å, –Ω–µ –Ω–∞—Ä—É—à–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç–µ–º.\n"
        f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—á–µ–Ω–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º (–Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è):\n"
        f"{hist_summary}"
        f"{topic_plan_block}"
    )


def _extract_questions(raw: str, provider_name: str, expected_count: int = 20) -> list:
    """Parse AI JSON and return questions array with exact expected_count."""
    raw = raw.replace("```json", "").replace("```", "").strip()
    try:
        parsed = json.loads(raw)
    except (ValueError, json.JSONDecodeError) as e:
        raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç {provider_name}: {e}\n–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç: {raw[:300]}")

    if isinstance(parsed, list):
        questions = parsed
    elif isinstance(parsed, dict) and isinstance(parsed.get("questions"), list):
        questions = parsed["questions"]
    else:
        raise ValueError(
            f"{provider_name}: –∫–æ—Ä–Ω–µ–≤–æ–π JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º –≤–æ–ø—Ä–æ—Å–æ–≤ "
            "–∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º —Å –ø–æ–ª–µ–º 'questions'"
        )

    if len(questions) != expected_count:
        raise ValueError(f"{provider_name}: –æ–∂–∏–¥–∞–µ—Ç—Å—è —Ä–æ–≤–Ω–æ {expected_count} –≤–æ–ø—Ä–æ—Å–æ–≤, –ø–æ–ª—É—á–µ–Ω–æ {len(questions)}")

    return questions


TYPE_LABELS = {
    "ru_to_gr":    "üá∑üá∫ ‚Üí üá¨üá∑ –ü–µ—Ä–µ–≤–æ–¥",
    "gr_to_ru":    "üá¨üá∑ ‚Üí üá∑üá∫ –ü–µ—Ä–µ–≤–æ–¥",
    "choose_form": "üìù –í—ã–±–æ—Ä —Ñ–æ—Ä–º—ã",
    "fill_blank":  "‚úèÔ∏è –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ–ø—É—Å–∫",
}

TYPE_NAMES_RU = {
    "ru_to_gr":    "–ü–µ—Ä–µ–≤–æ–¥ RU‚ÜíGR",
    "gr_to_ru":    "–ü–µ—Ä–µ–≤–æ–¥ GR‚ÜíRU",
    "choose_form": "–í—ã–±–æ—Ä —Ñ–æ—Ä–º—ã",
    "fill_blank":  "–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ–ø—É—Å–∫",
}


def _collect_question_errors(questions: list) -> dict:
    """Return {index: reason} for per-question schema/content errors."""
    errors = {}

    def canonicalize_option(option: str) -> str:
        # Keep diacritics: in Greek they can distinguish valid forms (e.g. œÄŒ±ŒπŒ¥ŒπŒ¨ vs œÄŒ±ŒπŒ¥ŒØŒ±),
        # and stripping them causes false-positive duplicate detection.
        normalized = unicodedata.normalize("NFC", option)
        normalized = "".join(ch for ch in normalized if not unicodedata.category(ch).startswith("P"))
        normalized = " ".join(normalized.split())
        return normalized.casefold()

    for i, q in enumerate(questions):
        if not isinstance(q, dict):
            errors[i] = "–æ–±—ä–µ–∫—Ç –≤–æ–ø—Ä–æ—Å–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å JSON-–æ–±—ä–µ–∫—Ç–æ–º"
            continue
        required = {"question", "options", "correctIndex", "explanation", "topic", "type"}
        if set(q.keys()) != required:
            errors[i] = f"–Ω–µ–≤–µ—Ä–Ω—ã–µ –ø–æ–ª—è: {sorted(q.keys())}"
            continue
        if not isinstance(q["question"], str) or not q["question"].strip():
            errors[i] = "–ø–æ–ª–µ 'question' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π"
            continue
        if not isinstance(q["explanation"], str) or not q["explanation"].strip():
            errors[i] = "–ø–æ–ª–µ 'explanation' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π"
            continue
        if q["type"] not in TYPE_LABELS:
            errors[i] = f"–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π type={q['type']!r}"
            continue
        if q.get("topic") not in MASTER_TOPICS:
            errors[i] = f"–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π topic={q.get('topic')!r}"
            continue
        opts = q.get("options")
        if not isinstance(opts, list) or len(opts) != 4:
            errors[i] = "options –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞"
            continue
        if any((not isinstance(o, str) or not o.strip()) for o in opts):
            errors[i] = "–∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤ options –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π"
            continue
        if not isinstance(q.get("correctIndex"), int) or not (0 <= q.get("correctIndex", -1) < len(opts)):
            errors[i] = f"correctIndex={q.get('correctIndex')} out of range"
            continue

    for i, q in enumerate(questions):
        if i in errors:
            continue
        opts = q["options"]
        canonical_opts = [canonicalize_option(o) for o in opts]
        if len(canonical_opts) != len(set(canonical_opts)):
            errors[i] = f"duplicate options detected: {opts}"

    return errors




def _collect_topic_plan_errors(questions: list, required_topics: list[str] | None) -> dict:
    """Return {index: reason} when question topic does not match server-side required slot."""
    if not required_topics:
        return {}
    errors = {}
    for i, q in enumerate(questions):
        if i >= len(required_topics):
            break
        expected = required_topics[i]
        actual = q.get("topic") if isinstance(q, dict) else None
        if actual != expected:
            errors[i] = f"topic –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å '{expected}', –ø–æ–ª—É—á–µ–Ω–æ '{actual}'"
    return errors

def _finalize_questions(questions: list) -> list:
    """Normalize topics, enforce validity and shuffle options server-side."""
    errors = _collect_question_errors(questions)
    if errors:
        first_i = min(errors)
        raise ValueError(f"Question {first_i}: {errors[first_i]}")

    # Normalise topic names ‚Äî guard against mixed Greek/Cyrillic characters
    for q in questions:
        q["topic"] = normalize_topic(q["topic"])

    # Server-side shuffle ‚Äî correct answer is never stuck at position 0
    for q in questions:
        correct_text = q["options"][q["correctIndex"]]
        random.shuffle(q["options"])
        q["correctIndex"] = q["options"].index(correct_text)

    return questions


async def _repair_questions_openai(client, system_prompt: str, questions: list, invalid: dict) -> list:
    """Regenerate only invalid question slots and return same-length replacement list."""
    bad_payload = [
        {
            "index": idx,
            "reason": reason,
            "original": questions[idx],
        }
        for idx, reason in sorted(invalid.items())
    ]
    n = len(bad_payload)
    repair_prompt = (
        f"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π {n} –°–û–í–ï–†–®–ï–ù–ù–û –ù–û–í–´–• –≤–æ–ø—Ä–æ—Å–æ–≤ –≤–∑–∞–º–µ–Ω –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö. "
        "–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON-–æ–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º questions, "
        f"–≤ –∫–æ—Ç–æ—Ä–æ–º —Ä–æ–≤–Ω–æ {n} –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ –∏ —Å–ø–∏—Å–æ–∫ –Ω–∏–∂–µ.\n\n"
        "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:\n"
        "1. –ü–æ–ª–µ topic –¥–æ–ª–∂–Ω–æ —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–µ–º–µ, —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤ reason (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ reason –≥–æ–≤–æ—Ä–∏—Ç "
        "¬´topic –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å \\'–û—Ç—Ä–∏—Ü–∞–Ω–∏–µ\\'¬ª ‚Äî –≤–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ò–ú–ï–ù–ù–û –ø—Ä–æ –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ –≤ –≥—Ä–µ—á–µ—Å–∫–æ–º, "
        "–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ª–æ–≤–æ ¬´–û—Ç—Ä–∏—Ü–∞–Ω–∏–µ¬ª –≤ –ø–æ–ª–µ topic).\n"
        "2. –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∑–Ω–∞–Ω–∏—è –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–µ–º–µ.\n"
        "3. –†–æ–≤–Ω–æ 4 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ (–±–µ–∑ –¥—É–±–ª–µ–π –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä—É/–ø—Ä–æ–±–µ–ª–∞–º/–ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏).\n"
        "4. –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã, correctIndex –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É.\n\n"
        "–ù–ï –∏—Å–ø—Ä–∞–≤–ª—è–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî —Å–æ–∑–¥–∞–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–æ–≤—ã–π –Ω–∞ –Ω—É–∂–Ω—É—é —Ç–µ–º—É.\n\n"
        "–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:\n"
        f"{json.dumps(bad_payload, ensure_ascii=False)}"
    )

    response = await client.chat.completions.create(
        model="gpt-4.1-mini",
        max_tokens=1800,
        temperature=OPENAI_TEMPERATURE,
        response_format={
            "type": "json_schema",
            "json_schema": {
                "name": "quiz_question_repairs",
                "strict": True,
                "schema": {
                    "type": "object",
                    "additionalProperties": False,
                    "required": ["questions"],
                    "properties": {
                        "questions": {
                            "type": "array",
                            "minItems": n,
                            "maxItems": n,
                            "items": {
                                "type": "object",
                                "additionalProperties": False,
                                "required": ["question", "options", "correctIndex", "explanation", "topic", "type"],
                                "properties": {
                                    "question": {"type": "string"},
                                    "options": {
                                        "type": "array",
                                        "minItems": 4,
                                        "maxItems": 4,
                                        "items": {"type": "string"},
                                    },
                                    "correctIndex": {"type": "integer", "minimum": 0, "maximum": 3},
                                    "explanation": {"type": "string"},
                                    "topic": {"type": "string", "enum": MASTER_TOPICS},
                                    "type": {"type": "string", "enum": list(TYPE_LABELS.keys())},
                                },
                            },
                        },
                    },
                },
            },
        },
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": repair_prompt},
        ],
    )
    raw = (response.choices[0].message.content or "").strip()
    return _extract_questions(raw, "gpt-4.1-mini repair", expected_count=n)


async def _generate_questions_openai(stats, session_dates, profile, required_topics=None):
    client = AsyncOpenAI(api_key=OPENAI_KEY, timeout=OPENAI_REQUEST_TIMEOUT_SEC)
    system_prompt = build_system_prompt(profile or {})
    dynamic_prompt = build_dynamic_prompt(stats, session_dates, profile or {}, required_topics=required_topics)
    max_attempts = OPENAI_MAX_ATTEMPTS
    retry_hint = ""
    last_error = None

    print("[openai] creating async client ‚Ä¶", flush=True)
    for attempt in range(1, max_attempts + 1):
        t0 = time.monotonic()
        user_prompt = f"{dynamic_prompt}{retry_hint}"
        print(
            f"[openai] sending request to gpt-4.1-mini (attempt {attempt}/{max_attempts}, prompt ~{len(user_prompt)} chars) ‚Ä¶",
            flush=True,
        )
        response = await client.chat.completions.create(
            model="gpt-4.1-mini",
            max_tokens=4500,
            temperature=OPENAI_TEMPERATURE,
            response_format={
                "type": "json_schema",
                "json_schema": {
                    "name": "quiz_questions",
                    "strict": True,
                    "schema": {
                        "type": "object",
                        "additionalProperties": False,
                        "required": ["questions"],
                        "properties": {
                            "questions": {
                                "type": "array",
                                "minItems": 20,
                                "maxItems": 20,
                                "items": {
                                    "type": "object",
                                    "additionalProperties": False,
                                    "required": ["question", "options", "correctIndex", "explanation", "topic", "type"],
                                    "properties": {
                                        "question": {"type": "string"},
                                        "options": {
                                            "type": "array",
                                            "minItems": 4,
                                            "maxItems": 4,
                                            "items": {"type": "string"},
                                        },
                                        "correctIndex": {"type": "integer", "minimum": 0, "maximum": 3},
                                        "explanation": {"type": "string"},
                                        "topic": {"type": "string", "enum": MASTER_TOPICS},
                                        "type": {"type": "string", "enum": list(TYPE_LABELS.keys())},
                                    },
                                },
                            },
                        },
                    },
                },
            },
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt},
            ],
        )
        elapsed = time.monotonic() - t0
        print(f"[openai] response received in {elapsed:.1f}s", flush=True)
        choice = response.choices[0]
        finish = choice.finish_reason
        raw = (choice.message.content or "").strip()
        print(f"[openai] finish_reason={finish!r}, content length={len(raw)} chars", flush=True)
        if finish == "length":
            raise ValueError("gpt-4.1-mini –æ–±—Ä–µ–∑–∞–ª –æ—Ç–≤–µ—Ç –ø–æ –ª–∏–º–∏—Ç—É —Ç–æ–∫–µ–Ω–æ–≤ (finish_reason='length').")
        if not raw:
            last_error = ValueError(f"gpt-4.1-mini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç (finish_reason={finish!r})")
        else:
            try:
                parsed = _extract_questions(raw, "gpt-4.1-mini")

                # Fast path: repair only broken question slots instead of full-regenerating all 20.
                for repair_round in range(1, 3):
                    errors = _collect_question_errors(parsed)
                    if not errors:
                        break
                    print(
                        f"[openai] attempting targeted repair round {repair_round}: {len(errors)} invalid question(s)",
                        flush=True,
                    )
                    repaired = await _repair_questions_openai(client, system_prompt, parsed, errors)
                    for repl, idx in zip(repaired, sorted(errors)):
                        parsed[idx] = repl

                topic_plan_errors = _collect_topic_plan_errors(parsed, required_topics)
                for repair_round in range(1, 3):
                    if not topic_plan_errors:
                        break
                    print(
                        f"[openai] enforcing server topic plan, repair round {repair_round}: {len(topic_plan_errors)} slot(s)",
                        flush=True,
                    )
                    repaired = await _repair_questions_openai(client, system_prompt, parsed, topic_plan_errors)
                    for repl, idx in zip(repaired, sorted(topic_plan_errors)):
                        parsed[idx] = repl
                    topic_plan_errors = _collect_topic_plan_errors(parsed, required_topics)

                parsed = _finalize_questions(parsed)
                topic_summary = ", ".join(
                    f"{i+1}:{q['topic']}" for i, q in enumerate(parsed)
                )
                print(f"[openai] parsed response ok ({len(raw)} chars)", flush=True)
                print(f"[openai] final topic assignments: {topic_summary}", flush=True)
                if required_topics:
                    mismatches = [
                        f"q{i+1}: expected={required_topics[i]!r} got={parsed[i]['topic']!r}"
                        for i in range(min(len(parsed), len(required_topics)))
                        if parsed[i]["topic"] != required_topics[i]
                    ]
                    if mismatches:
                        print(f"[openai] WARNING topic mismatches remain: {'; '.join(mismatches)}", flush=True)
                    else:
                        print("[openai] topic plan fully satisfied", flush=True)
                return parsed
            except ValueError as e:
                last_error = e

        if attempt < max_attempts:
            print(f"[openai] validation failed, retrying: {last_error}", flush=True)
            retry_hint = (
                "\n\n–í–ê–ñ–ù–û: –ò—Å–ø—Ä–∞–≤—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–æ–≤—ã–π JSON —Å –Ω—É–ª—è. "
                "–í–æ –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–æ–≤–Ω–æ 4 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (–±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–∞–∂–µ –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä—É/–ø—Ä–æ–±–µ–ª–∞–º). "
                f"–û—à–∏–±–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–æ–ø—ã—Ç–∫–∏: {last_error}"
            )

    raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π –∫–≤–∏–∑ –∑–∞ {max_attempts} –ø–æ–ø—ã—Ç–∫–∏. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_error}")


async def generate_questions(stats, session_dates, profile, required_topics=None):
    return await _generate_questions_openai(stats, session_dates, profile, required_topics=required_topics)
